<!--
Copyright (c) 2014 muiis Authors. All rights reserved.

-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-localstorage/core-localstorage.html">

<!--


-->

<polymer-element name="oauth-dropbox" attributes="client code">
  <template>

    <link rel="stylesheet" href="oauth-dropbox.css">

    <core-localstorage name="code" value="{{code}}"></core-localstorage>
  </template>
  <script>
  (function() {

    // Polyfill crypto.getRandomValues
    if ( typeof window.crypto === 'undefined' )
      window.crypto = {};
    if ( typeof window.crypto.getRandomValues === 'undefined' ) {
      window.crypto.getRandomValues = function(typedArray) {
        for ( var i = 0 ; i < typedArray.length ; i++ )
          typedArray[i] = Math.floor(Math.random() * Math.pow(2, 8 * typedArray.BYTES_PER_ELEMENT));
      };
    }

    var csrf = {
      token: null,
      create: function() {
        var tmp = new Uint16Array(1);
        window.crypto.getRandomValues(tmp);
        return ( this.token = btoa(tmp[0].toString(2)) );
      }
    };

    Polymer('oauth-dropbox', {
      code: '',
      popup: null,

      observe: {
        'popup.closed': 'popupClosed'
      },

      created: function() {
        if ( /^#oauth\-dropbox\?code=(.+)&state=(.+)$/.test(window.location.hash) && window.opener ) {
          window.opener.postMessage({code: RegExp.$1, state: RegExp.$2}, window.location);
          window.close();
        }
        else {
          window.addEventListener('message', function (event) {
            this.popup = null;

            if ( event.data.state === csrf.token ) {
              this.code = event.data.code;

              this.fire('login', {code: this.code});
            }
            else {
              // potential cross side scripting... ~ error
              this.fire('csrf', {send: csrf.token, recived: event.data.state});
            }

          }.bind(this));
        }
      },

      oauth: function() {
        this.popup = window.open('https://www.dropbox.com/1/oauth2/authorize' +
          '?client_id=' + this.client +
          '&response_type=code' +
          '&redirect_uri=' + window.location.protocol + '//' + window.location.host + window.location.pathname +
          '&state=' + csrf.create());
      },

      popupClosed: function(oval, nval) {
        if ( nval ) {
          this.fire('closed');
        }
      }
    });

  })();
  </script>
</polymer-element>
